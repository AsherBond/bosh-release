user vcap;
worker_processes  2;
daemon off;

error_log  /var/vcap/sys/log/nginx/error.log;
pid        /var/vcap/sys/run/nginx/nginx.pid;

events {
  worker_connections  8192;
}

http {
  include       /var/vcap/jobs/blobstore/config/mime.types;
  default_type  text/html;
  server_tokens off;

  access_log	/var/vcap/sys/log/nginx/access.log;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  keepalive_timeout  75 20;

  gzip                 on;
  gzip_min_length      1250;
  gzip_buffers         16 8k;
  gzip_comp_level      2;
  gzip_proxied         any;
  gzip_types           text/plain text/css application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_vary            on;
  gzip_disable         "MSIE [1-6]\.(?!.*SV1)";

}

upstream backend {
  server 127.0.0.1:<%= properties.blobstore.backend_port %>;
}

server {
  listen      <%= properties.blobstore.port %>;
  server_name "";

  access_log  /var/vcap/sys/log/nginx/blobstore_access.log;
  error_log   /var/vcap/sys/log/nginx/blobstore_error.log;

  client_max_body_size 1G;

  error_page 400 = /400.html;
  location /400.html {
    internal;

    if ($http_host) {
      break;
    }

    proxy_buffering             off;
    proxy_set_header            X-Real_IP $remote_addr;
    proxy_set_header            X-Forwarded_For $proxy_add_x_forwarded_for;
    proxy_redirect              off;
    proxy_connect_timeout       10;
    proxy_send_timeout          30;
    proxy_read_timeout          30;
    proxy_pass                  http://backend;
  }

  location / {
    proxy_buffering             off;
    proxy_set_header            X-Real_IP $remote_addr;
    proxy_set_header            X-Forwarded_For $proxy_add_x_forwarded_for;
    proxy_redirect              off;
    proxy_connect_timeout       10;
    proxy_send_timeout          30;
    proxy_read_timeout          30;
    proxy_pass                  http://backend;
  }

  # Handle file upload
  location = /resources {
      # Pass altered request body to this location
      upload_pass   @upload;

      # Store files to this directory
      upload_store /var/vcap/data/blobstore/tmp/uploads;

      # Allow uploaded files to be read only by user
      upload_store_access user:r;

      # Set specified fields in request body
      upload_set_form_field $upload_field_name.name "$upload_file_name";
      upload_set_form_field $upload_field_name.content_type "$upload_content_type";
      upload_set_form_field $upload_field_name.path "$upload_tmp_path";

      upload_max_file_size 0;
      upload_cleanup 400 404 499 500-505;
  }

  location @upload {
    proxy_pass http://backend;
  }

  location /protected/ {
    internal;
    alias /var/vcap/data/blobstore/store/;
  }
}
